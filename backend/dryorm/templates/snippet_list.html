{% extends 'base.html' %}
{% block title %}Dry ORM - Feed{% endblock %}

{% block content %}
<div class="flex flex-col flex-1 overflow-hidden">
    <div class="flex items-center w-full px-4 py-3 bg-white border-b border-django-primary/20">
        <div class="htmx-indicator w-5 h-5 border-4 border-gray-400 border-t-transparent rounded-full animate-spin mr-3"></div>
        <input type="text"
               name="q"
               placeholder="Search snippets..."
               autocomplete="off"
               autofocus
               class="w-full px-3 py-2 focus:outline-none"

               hx-trigger="input changed delay:500ms, keyup[key=='Enter']"
               hx-get="{% url "list" %}"
               hx-include="[name='q']"
               hx-target="#main-section"
               hx-swap="outerHTML"
               hx-indicator=".htmx-indicator"
               />
    </div>

    <main id="main-section" class="flex-1 overflow-y-auto">
        <ul>
            {% for object in object_list %}
                <li class="border-b border-gray-200" x-data="{ expanded: false }">
                    <div class="flex items-center px-4 py-3 hover:bg-django-secondary/10 transition cursor-pointer" @click="expanded = !expanded">
                        <div class="flex flex-col flex-grow truncate">
                            <a href="{% url 'detail' object.slug %}" class="text-lg font-semibold text-django-primary truncate hover:underline" @click.stop>{{ object.name }}</a>
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <span>{{ object.database }}</span>
                                <span>â€¢</span>
                                {% if object.ref_type %}
                                    <span class="text-purple-600" title="{% if object.sha %}{{ object.sha }}{% endif %}">{% if object.ref_type == 'pr' %}PR #{{ object.ref_id }}{% elif object.ref_type == 'branch' %}{{ object.ref_id }}{% elif object.ref_type == 'tag' %}{{ object.ref_id }}{% endif %}{% if object.sha %} <span class="hidden sm:inline font-mono">@ {{ object.sha|slice:":7" }}</span>{% endif %}</span>
                                {% elif object.orm_version %}
                                    <span>{{ object.orm_version }}</span>
                                {% endif %}
                                <span>â€¢</span>
                                <span>{{ object.created|timesince }}</span>
                            </div>
                        </div>
                        <div class="ml-2 p-1">
                            <svg class="w-4 h-4 transform transition-transform" :class="{ 'rotate-90': expanded }" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                    <div class="px-4 py-3 border-t text-xs bg-gray-50" x-show="expanded">
                        {% with parsed=object.parse_code %}
                        <div class="flex flex-wrap gap-1">
                            {% for import in parsed.imports %}
                                <span class="px-1.5 py-0.5 bg-django-secondary/20 text-django-text rounded-full">{{ import }}</span>
                            {% endfor %}
                            {% for class in parsed.classes %}
                                <span class="px-1.5 py-0.5 bg-django-primary/20 text-django-primary rounded-full">{{ class }}</span>
                            {% endfor %}
                            {% if not parsed.imports and not parsed.classes %}
                                <span class="text-gray-500">No imports or classes found</span>
                            {% endif %}
                        </div>
                        {% endwith %}
                    </div>
                </li>
            {% empty %}
                <li class="py-8 text-center text-gray-500">No snippets found. ðŸ˜”</li>
            {% endfor %}
        </ul>
        {% if is_paginated %}
            <nav class="mt-4 flex justify-center space-x-2 text-sm text-django-primary">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="px-2 py-1 border border-gray-300 rounded">First</a>
                    <a href="?page={{ page_obj.previous_page_number }}"
                       class="px-2 py-1 border border-gray-300 rounded">Prev</a>
                {% endif %}
                <span class="px-3 py-1">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}"
                       class="px-2 py-1 border border-gray-300 rounded">Next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}"
                       class="px-2 py-1 border border-gray-300 rounded">Last</a>
                {% endif %}
            </nav>
        {% endif %}
    </main>
</div>

{% endblock %}

