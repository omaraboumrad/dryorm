volumes:
    postgres_data: {}
    postgres_snippets_data: {}
    mariadb_snippets_data: {}
    django_cache: {}

networks:
  snippets_net:
    driver: bridge
    internal: true

services:

    database:
        image: postgres:alpine
        environment:
            POSTGRES_USER: dryorm
            POSTGRES_PASSWORD: dryorm
            POSTGRES_DB: dryorm
        volumes:
            - postgres_data:/var/lib/postgresql/data

    database_postgres:
        image: postgres:alpine
        environment:
            POSTGRES_USER: dryorm
            POSTGRES_PASSWORD: dryorm
            POSTGRES_DB: dryorm
        volumes:
            - postgres_snippets_data:/var/lib/postgresql/data
        networks:
            - snippets_net

    database_mariadb:
        image: yobasystems/alpine-mariadb
        environment:
            MYSQL_ROOT_PASSWORD: dryorm
            MYSQL_DATABASE: dryorm
            MYSQL_USER: dryorm
            MYSQL_PASSWORD: dryorm
        volumes:
            - mariadb_snippets_data:/var/lib/mysql
        networks:
            - snippets_net

    redis:
        image: redis:7.4-alpine

    backend:
        build: ./backend/
        image: dryorm/backend
        volumes:
            - ./backend:/app
            - django_cache:/app/cache
            - /var/run/docker.sock:/var/run/docker.sock
        depends_on:
            - database
            - database_postgres
            - database_mariadb
            - redis
        ports:
            - 8090:8000
        command: python manage.py runserver 0.0.0.0:8000
        env_file: .env
        networks:
            - default
            - snippets_net

    # Executors - Multi-stage builds

    executor-python-django-postgres-4.2.26:
        build:
            context: ./executors/python-django
            dockerfile: Dockerfile.multi
            target: postgres-4.2.26
        image: dryorm-executor/python-django-postgres-4.2.26
        command: /bin/true

    executor-python-django-postgres-5.2.8:
        build:
            context: ./executors/python-django
            dockerfile: Dockerfile.multi
            target: postgres-5.2.8
        image: dryorm-executor/python-django-postgres-5.2.8
        command: /bin/true

    executor-python-django-mariadb-4.2.26:
        build:
            context: ./executors/python-django
            dockerfile: Dockerfile.multi
            target: mariadb-4.2.26
        image: dryorm-executor/python-django-mariadb-4.2.26
        command: /bin/true

    executor-python-django-mariadb-5.2.8:
        build:
            context: ./executors/python-django
            dockerfile: Dockerfile.multi
            target: mariadb-5.2.8
        image: dryorm-executor/python-django-mariadb-5.2.8
        command: /bin/true

    # SQLAlchemy Executors

    executor-python-sqlalchemy-postgres-2.0:
        build:
            context: ./executors/python-sqlalchemy
            dockerfile: Dockerfile.multi
            target: postgres-2.0
        image: dryorm-executor/python-sqlalchemy-postgres-2.0
        command: /bin/true

    executor-python-sqlalchemy-mariadb-2.0:
        build:
            context: ./executors/python-sqlalchemy
            dockerfile: Dockerfile.multi
            target: mariadb-2.0
        image: dryorm-executor/python-sqlalchemy-mariadb-2.0
        command: /bin/true

    # Prisma Executors

    executor-nodejs-prisma-postgres-6.3:
        build:
            context: ./executors/nodejs-prisma
            dockerfile: Dockerfile.multi
            target: postgres-6.3
        image: dryorm-executor/nodejs-prisma-postgres-6.3
        command: /bin/true

    executor-nodejs-prisma-mariadb-6.3:
        build:
            context: ./executors/nodejs-prisma
            dockerfile: Dockerfile.multi
            target: mariadb-6.3
        image: dryorm-executor/nodejs-prisma-mariadb-6.3
        command: /bin/true

    executor-nodejs-prisma-sqlite-6.3:
        build:
            context: ./executors/nodejs-prisma
            dockerfile: Dockerfile.multi
            target: sqlite-6.3
        image: dryorm-executor/nodejs-prisma-sqlite-6.3
        command: /bin/true
